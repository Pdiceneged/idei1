import pandas as pd
import gspread
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import streamlit as st
import base64

st.set_page_config(
    page_title="Ideias",
    page_icon="üå±"
)
@st.cache_data()
def get_img_as_base64(file):
    with open(file, "rb") as f:
        data = f.read()
    return base64.b64encode(data).decode()

img = get_img_as_base64("esgfundo.png")
img2 = get_img_as_base64("esgfundo.png")

page_bg_img = f"""
<style>
header, footer {{
    visibility: hidden !important;
}}

#MainMenu {{
    visibility: visible !important;
    color: #F44D00;
}}

[data-testid="stAppViewContainer"] > .main {{
    background-image: url("data:fundoesg4k/png;base64,{img}");
    background-size: cover; 
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
}}
[data-testid="stSidebar"] > div:first-child {{
    background-image: url("data:esgfundo1/png;base64,{img2}");
    background-position: center; 
    background-size: cover;
    background-repeat: no-repeat;
    background-attachment: fixed;
}}

[data-testid="stHeader"] {{
    background: rgba(0,0,0,0);
}}

[data-testid="stToolbar"] {{
    right: 2rem;
}}

.stTextInput>div>div>input[type="text"] {{
    background-color: #CFE6D2; 
    color: #000; 
    border-radius: 7px; 
    border: 2px solid #000010; 
    padding: 5px; 
    width: 500; 
}}

@media (max-width: 360px) {{
    [data-testid="stAppViewContainer"] > .main, [data-testid="stSidebar"] > div:first-child {{
        background-size: auto;
    }}
}}
</style>
"""

st.markdown(page_bg_img, unsafe_allow_html=True)
st.sidebar.image("esgfundo.png", width=250)


sinonimos = {
    "Pobreza extrema, inclus√£o social, desigualdade econ√¥mica, fome, vulnerabilidade, acesso √† educa√ß√£o, emprego digno, sustentabilidade social, igualdade de oportunidades, resili√™ncia financeira, prote√ß√£o social, microfinan√ßas, redu√ß√£o da pobreza, empoderamento econ√¥mico, assist√™ncia social, fornecimento de recursos, renda m√≠nima, justi√ßa social, desenvolvimento inclusivo, apoio comunit√°rio.": 'Erradica√ß√£o da pobreza',
    "Seguran√ßa alimentar, agricultura sustent√°vel, desnutri√ß√£o, agricultura familiar, produ√ß√£o de alimentos, soberania alimentar, desperd√≠cio de alimentos, seguro agr√≠cola, acesso √† √°gua para irriga√ß√£o, diversidade alimentar, infraestrutura agr√≠cola, tecnologia agr√≠cola, fome oculta, agricultura de subsist√™ncia, com√©rcio justo, pol√≠ticas alimentares, desenvolvimento rural, agricultura de precis√£o, sistemas agroflorestais, resili√™ncia agr√≠cola.": "Fome zero e agricultura sustent√°vel",
    "nascimento familia, filhos m√£es pais famillia saude bem estar, familiar cuidado Sa√∫de p√∫blica, preven√ß√£o de doen√ßas, acesso √† sa√∫de, bem-estar mental, vacina√ß√£o, saneamento b√°sico, educa√ß√£o em sa√∫de, aten√ß√£o prim√°ria, qualidade de vida, cobertura universal de sa√∫de, doen√ßas transmiss√≠veis, sa√∫de materna, sa√∫de infantil, tratamento m√©dico acess√≠vel, pesquisa biom√©dica, infraestrutura de sa√∫de, promo√ß√£o da sa√∫de, tecnologia m√©dica, assist√™ncia m√©dica preventiva, medicina personalizada.": "Sa√∫de e bem-estar",
    "aprendizes  desenvolvimento webnar webinar aprender aprendizado Inclus√£o educacional, alfabetiza√ß√£o, acesso √† educa√ß√£o, ensino de qualidade, equidade educacional, educa√ß√£o inclusiva, desenvolvimento de habilidades, tecnologias educacionais, aprendizado ao longo da vida, parcerias educacionais, infraestrutura escolar, qualifica√ß√£o de professores, educa√ß√£o STEM Ci√™ncia, Tecnologia, Engenharia e Matem√°tica, educa√ß√£o para a cidadania, avalia√ß√£o educacional, inova√ß√£o pedag√≥gica, educa√ß√£o n√£o formal, educa√ß√£o √† dist√¢ncia, educa√ß√£o para a sustentabilidade, educa√ß√£o de base comunit√°ria.": "Educa√ß√£o de qualidade",
    "Empoderamento feminino, igualdade salarial, participa√ß√£o pol√≠tica das mulheres, direitos reprodutivos, viol√™ncia de g√™nero, educa√ß√£o de g√™nero, equidade de oportunidades, lideran√ßa feminina, elimina√ß√£o de estere√≥tipos de g√™nero, maternidade segura, sa√∫de sexual e reprodutiva, paridade de g√™nero, discrimina√ß√£o de g√™nero, igualdade no local de trabalho, acesso a recursos para mulheres, direitos das mulheres, mulheres na ci√™ncia e tecnologia, empreendedorismo feminino, emprego digno para mulheres, participa√ß√£o igualit√°ria em esportes.": "Igualdade de g√™nero",
    "Acesso √† √°gua pot√°vel, saneamento b√°sico, gest√£o sustent√°vel da √°gua, higiene adequada, tratamento de √°gua, abastecimento de √°gua seguro, infraestrutura h√≠drica, qualidade da √°gua, uso eficiente da √°gua, reuso de √°gua, saneamento rural, sistemas de esgoto, √°gua e saneamento em situa√ß√µes de emerg√™ncia, prote√ß√£o de fontes de √°gua, tecnologias de saneamento inovadoras, promo√ß√£o da sa√∫de por meio da √°gua limpa, participa√ß√£o comunit√°ria em projetos h√≠dricos, educa√ß√£o sobre recursos h√≠dricos, √°gua e desenvolvimento sustent√°vel, equidade no acesso √† √°gua e saneamento.": "√Ågua pot√°vel e saneamento",
    "Energias renov√°veis, acesso √† eletricidade, efici√™ncia energ√©tica, energia sustent√°vel, fontes de energia limpa, inova√ß√£o em energia, eletrifica√ß√£o rural, desenvolvimento de tecnologias verdes, energia solar, energia e√≥lica, biomassa, energia hidrel√©trica, hidrogenio verde , infraestrutura energ√©tica, acesso a tecnologias de energia, democratiza√ß√£o da energia, combate √† pobreza energ√©tica, educa√ß√£o energ√©tica, parcerias para o acesso √† energia, investimento em infraestrutura energ√©tica, transi√ß√£o para uma matriz energ√©tica sustent√°vel.": "Energia limpa e acess√≠vel",
    "Emprego digno, crescimento econ√¥mico inclusivo, redu√ß√£o do desemprego, igualdade salarial, empreendedorismo, inova√ß√£o econ√¥mica, desenvolvimento de habilidades profissionais, ambientes de trabalho seguros, erradica√ß√£o do trabalho infantil, trabalho decente para todos, prote√ß√£o social, emprego sustent√°vel, formaliza√ß√£o do trabalho, desenvolvimento de pequenas e m√©dias empresas, bancariza√ß√£o, inclus√£o financeira, responsabilidade social corporativa, economia verde, com√©rcio justo, redu√ß√£o da desigualdade de renda.": "Trabalho decente e crescimento econ√¥mico",
    "Inova√ß√£o tecnol√≥gica, infraestrutura sustent√°vel, desenvolvimento de tecnologias verdes, industrializa√ß√£o, acesso √† tecnologia da informa√ß√£o, pesquisa e desenvolvimento, infraestrutura de transporte, inclus√£o digital, desenvolvimento de habilidades tecnol√≥gicas, desenvolvimento de infraestrutura industrial, investimento em infraestrutura, conectividade global, inova√ß√£o em energias limpas, desenvolvimento de zonas industriais sustent√°veis, acesso a servi√ßos de telecomunica√ß√£o, moderniza√ß√£o da infraestrutura, fomento √† inova√ß√£o, desenvolvimento de parcerias p√∫blico-privadas, desenvolvimento de infraestrutura rural, promo√ß√£o da pesquisa aplicada.": "Ind√∫stria, inova√ß√£o e infraestrutura",
    "Equidade social, distribui√ß√£o de renda, inclus√£o social, oportunidades iguais, participa√ß√£o cidad√£, desenvolvimento inclusivo, acesso √† educa√ß√£o e sa√∫de, mobilidade social, combate √† discrimina√ß√£o, prote√ß√£o dos direitos humanos, pol√≠ticas de inclus√£o, empoderamento de comunidades marginalizadas, igualdade de oportunidades econ√¥micas, participa√ß√£o pol√≠tica equitativa, coopera√ß√£o internacional para redu√ß√£o de desigualdades, acesso a servi√ßos b√°sicos para todos, promo√ß√£o da diversidade, medidas contra a discrimina√ß√£o de g√™nero, ra√ßa e orienta√ß√£o sexual, acesso a recursos para grupos vulner√°veis, emprego e oportunidades justas para todos.": "Redu√ß√£o das desigualdades",
    "reclica reciclagem reusa reduzir reutiliza√ß√£o coleta lixo papel plastico papel√£o vidro organico Urbaniza√ß√£o sustent√°vel, planejamento urbano, habita√ß√£o acess√≠vel, mobilidade sustent√°vel, infraestrutura resiliente, gest√£o de res√≠duos s√≥lidos, desenvolvimento de √°reas verdes, acesso a servi√ßos b√°sicos nas cidades, participa√ß√£o comunit√°ria, inclus√£o social urbana, preserva√ß√£o do patrim√¥nio cultural, redu√ß√£o da polui√ß√£o do ar e sonora, seguran√ßa urbana, constru√ß√£o sustent√°vel, efici√™ncia energ√©tica em edifica√ß√µes, planejamento de uso do solo, transporte p√∫blico eficiente, resili√™ncia a desastres naturais, desenvolvimento de tecnologias urbanas sustent√°veis, promo√ß√£o da cultura local nas cidades.": "Cidades e comunidades sustent√°veis",
    "Consumo consciente, produ√ß√£o sustent√°vel, desperd√≠cio zero, ciclo de vida dos produtos, efici√™ncia no uso de recursos, economia circular, compras √©ticas, redu√ß√£o da pegada de carbono, consumo de energia respons√°vel, certifica√ß√µes ambientais, ecoefici√™ncia, incentivo ao consumo local, reutiliza√ß√£o de produtos, redu√ß√£o do uso de pl√°stico, educa√ß√£o para o consumo sustent√°vel, responsabilidade das empresas na cadeia de produ√ß√£o, inova√ß√£o em processos sustent√°veis, gest√£o respons√°vel de res√≠duos, agricultura sustent√°vel, redu√ß√£o da emiss√£o de poluentes.": "Consumo e produ√ß√£o respons√°veis",
    "Mitiga√ß√£o das mudan√ßas clim√°ticas, adapta√ß√£o √†s mudan√ßas clim√°ticas, energias renov√°veis, redu√ß√£o das emiss√µes de gases de efeito estufa, transi√ß√£o para uma economia de baixo carbono, preserva√ß√£o de ecossistemas cruciais para o clima, conscientiza√ß√£o ambiental, medidas para a efici√™ncia energ√©tica, planejamento urbano sustent√°vel, tecnologias limpas, resili√™ncia clim√°tica, preserva√ß√£o da biodiversidade, agricultura de baixa emiss√£o de carbono, reflorestamento e conserva√ß√£o florestal, coopera√ß√£o internacional em mudan√ßas clim√°ticas, regulamenta√ß√£o ambiental eficaz, educa√ß√£o sobre mudan√ßas clim√°ticas, financiamento para a√ß√µes clim√°ticas, monitoramento e relat√≥rios clim√°ticos, participa√ß√£o cidad√£ na mitiga√ß√£o clim√°tica.": "A√ß√£o contra a mudan√ßa global do clima",
    "agua praia praiano praias acquatica peixe  aquatica agua Conserva√ß√£o marinha, pesca sustent√°vel, preserva√ß√£o de ecossistemas aqu√°ticos, prote√ß√£o da biodiversidade marinha, combate √† polui√ß√£o dos oceanos, √°reas marinhas protegidas, aquicultura sustent√°vel, monitoramento dos oceanos, redu√ß√£o do descarte de pl√°sticos no mar mares praia praias, recupera√ß√£o de habitats marinhos, conscientiza√ß√£o sobre a vida marinha, combate √† pesca ilegal, conserva√ß√£o de esp√©cies amea√ßadas aqu√°ticas, oceanografia, ecoturismo marinho respons√°vel, restaura√ß√£o de recifes de coral, gest√£o sustent√°vel de recursos marinhos, ecologia marinha, inova√ß√µes para a conserva√ß√£o marinha, coopera√ß√£o internacional em quest√µes oce√¢nicas.praias praia": "Vida na √°gua",
    "conserva floresta Conserva√ß√£o da biodiversidade, reflorestamento, combate √† desertifica√ß√£o, prote√ß√£o de ecossistemas terrestres, manejo sustent√°vel de florestas, preven√ß√£o da extin√ß√£o de esp√©cies, conserva√ß√£o de habitats naturais, restaura√ß√£o de ecossistemas degradados, biodiversidade em √°reas urbanas, prote√ß√£o de √°reas de import√¢ncia ecol√≥gica, redu√ß√£o da perda de solo, combate √† ca√ßa ilegal, conserva√ß√£o de √°reas de import√¢ncia cultural, monitoramento de esp√©cies amea√ßadas, educa√ß√£o ambiental para a vida terrestre, uso sustent√°vel da terra, prote√ß√£o contra invas√µes biol√≥gicas, incentivo √† agricultura sustent√°vel, medidas para a preserva√ß√£o de fauna e flora, desenvolvimento de tecnologias para a conserva√ß√£o.":"Vida terrestre",
    "Estado de direito, justi√ßa social, paz duradoura, direitos humanos, acesso √† justi√ßa, combate √† corrup√ß√£o, participa√ß√£o cidad√£, igualdade perante a lei, institui√ß√µes transparentes, redu√ß√£o da viol√™ncia, prote√ß√£o de v√≠timas de crimes, combate ao tr√°fico humano, promo√ß√£o da n√£o discrimina√ß√£o, resolu√ß√£o pac√≠fica de conflitos, constru√ß√£o de capacidades institucionais, desenvolvimento de sistemas judiciais eficazes, promo√ß√£o da verdade e reconcilia√ß√£o, combate √† impunidade, coopera√ß√£o internacional em quest√µes de justi√ßa, educa√ß√£o para a paz.": "Paz, Justi√ßa e institui√ß√µes eficazes",
    "Coopera√ß√£o internacional, parcerias p√∫blico privada, desenvolvimento sustent√°vel, engajamento global, financiamento para o desenvolvimento, compartilhamento de conhecimento, colabora√ß√£o entre setores, inova√ß√£o social, tecnologias para o desenvolvimento, capacita√ß√£o de comunidades locais, transfer√™ncia de tecnologia, desenvolvimento de capacidades institucionais, mobiliza√ß√£o de recursos, desenvolvimento de parcerias multissetoriais, advocacia para os ODS, promo√ß√£o do voluntariado, coopera√ß√£o Sul-Sul, monitoramento e avalia√ß√£o conjunta, participa√ß√£o da sociedade civil, coopera√ß√£o triangular (pa√≠ses desenvolvidos, em desenvolvimento e institui√ß√µes internacionais).": "Parcerias e meios de implementa√ß√£o",

}
gc_credentials = {
    "type": st.secrets['google_bigquery']['type'],
    "project_id": st.secrets['google_bigquery']['project_id'],
    "private_key_id": st.secrets['google_bigquery']['private_key_id'],
    "private_key": st.secrets['google_bigquery']['private_key'],
    "client_email": st.secrets['google_bigquery']['client_email'],
    "client_id": st.secrets['google_bigquery']['client_id'],
    "auth_uri": st.secrets['google_bigquery']['auth_uri'],
    "token_uri": st.secrets['google_bigquery']['token_uri'],
    "auth_provider_x509_cert_url": st.secrets['google_bigquery']['auth_provider_x509_cert_url'],
    "client_x509_cert_url": st.secrets['google_bigquery']['client_x509_cert_url']
}

gc = gspread.service_account_from_dict(gc_credentials)
planilha_url = st.secrets['google_sheets']['planilha_url']
dados = gc.open_by_url(planilha_url).worksheet('Respostas ao formul√°rio 1')
colunas = dados.get_all_values()
colunas_selecionadas = ['Carimbo de data/hora', 'Aviso de privacidade de dados - Declaro estar ciente e autorizo a coleta das informa√ß√µes para este formul√°rio.', 'Nome e sobrenome', 'Estado (UF) que originou a ideia:', 'Voc√™ poderia compartilhar conosco o embri√£o da sua ideia, mesmo que ainda n√£o esteja totalmente estruturada?']

df = pd.DataFrame(data=dados.get_all_values(), columns=colunas[0])[colunas_selecionadas]
tfidf_vectorizer = TfidfVectorizer(stop_words='english')
tfidf_matrix = tfidf_vectorizer.fit_transform(df.values.flatten())

def calcular_similaridade(frase_de_entrada, df, ods_selecionadas=None):
    frase_preprocessada = frase_de_entrada.lower()

    for palavra, sinonimo in sinonimos.items():
        frase_preprocessada = frase_preprocessada.replace(palavra, sinonimo)

    try:
        tfidf_vectorizer = TfidfVectorizer(stop_words='english')
        tfidf_matrix = tfidf_vectorizer.fit_transform(
            df.fillna('').values.flatten())
        if tfidf_matrix.shape[1] == 0:
            return []
    except ValueError:
        return []

    similaridade_com_frase = cosine_similarity(tfidf_vectorizer.transform([frase_preprocessada]), tfidf_matrix)

    threshold = 0.00
    resultados = []

    for i, row in enumerate(df.index):
        for j, col in enumerate(df.columns):
            celula = str(df.at[row, col])
            similaridade_celula = similaridade_com_frase[0][i * len(df.columns) + j]

            if similaridade_celula > threshold and celula:
                if not ods_selecionadas or any(ods in celula for ods in ods_selecionadas):
                    resultado = {
                        "Linha": row,
                        "Coluna": col,
                        "Data": df.at[row, 'Carimbo de data/hora'],
                        "Nome": df.at[row, 'Nome e sobrenome'],
                        "UF": df.at[row, 'Estado (UF) que originou a ideia:'],
                        "Iniciativa": df.at[row, 'Voc√™ poderia compartilhar conosco o embri√£o da sua ideia, mesmo que ainda n√£o esteja totalmente estruturada?'],
                        "Grau de Similaridade": f"{similaridade_celula * 100:.2f}"
                    }
                    resultados.append(resultado)

            resultados = sorted(resultados, key=lambda x: float(x['Grau de Similaridade']), reverse=True)

    return resultados

st.title("Iniciativas ESG - Similarity üå±")
frase_de_entrada = st.text_input("Digite um tema para iniciativas (ou 'sair' para encerrar): ")

if frase_de_entrada.lower() == 'sair':
    st.stop()

resultados = calcular_similaridade(frase_de_entrada, df=df)

if frase_de_entrada:
    resultados = calcular_similaridade(frase_de_entrada, df)

    if resultados:
        st.header("Resultado:")
        linhas_filtradas = set()

        for resultado in resultados:
            linha = resultado['Linha']

            if linha not in linhas_filtradas:
                st.subheader(f" {resultado['Coluna']}: {resultado['Voc√™ poderia compartilhar conosco o embri√£o da sua ideia, mesmo que ainda n√£o esteja totalmente estruturada? ']}")
                st.write(f"**Descri√ß√£o:** {resultado['Carimbo de data/hora']}")
                st.write(f"**Objetivo:** {resultado['Nome e sobrenome']}")
                st.write(f"**ODS's atendidas:** {resultado['Estado (UF) que originou a ideia:']}")
                st.write(f"**Grau de Similaridade:** {resultado['Grau de Similaridade']}%")
                st.markdown("---")

                linhas_filtradas.add(linha)
    else:
        st.warning("Nenhum resultado encontrado.")

st.sidebar.markdown("---")
st.sidebar.markdown("Desenvolvido por [PedroFS](https://linktr.ee/Pedrofsf)")
